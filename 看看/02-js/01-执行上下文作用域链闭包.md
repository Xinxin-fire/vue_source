## 01-执行上下文/作用域链/闭包

### 一、什么是执行上下文

执行上下文是指JavaScript代码的执行环境，在JavaScript中有三种执行上下文类型

- 全局执行上下文：不在函数内部的代码都在全局上下文，全局上下文会创建一个全局的window对象，并将this指向window
- 函数执行上下文：每当一个函数被调用时会创建一个新的函数上下文
- Eval函数执行上下文：eval函数内部有自己的执行上下文

### 二、执行栈

执行栈是即调用栈，遵循后进先出原则，JavaScript引擎会先将全局执行上下文压入当前执行栈，每当引擎遇到一个函数调用会为该函数创建一个新的执行上下文并压入栈的顶部。

因此A函数里调用了B函数时，会先执行B函数再执行A函数，最后执行全局上下文。

### 三、创建执行上下文

创建执行上下文有两个阶段：1.创建阶段、2.执行阶段

在创建阶段会发生三件事

1. this值的绑定
   - 全局执行上下文中this执行window
   - 函数执行上下文中，若函数作为方法被一个对象调用则this指向该对象，否则this指向window或者undefined（严格模式下）
   - 箭头函数中的this本身没有指向，但他会指向离他最近的一个的this
2. 创建词法环境组件
   - 词法环境内部有两个组件：1.环境记录器(作用域)和2.一个外部的环境引用（全局环境或者函数环境）
3. 创建变量环境组件

### 四、函数提升和变量提升

- 用var声明的变量会出现变量提升，即在其作用域的顶部会先进行变量的声明
- 通过具名定义的函数，会出现函数替身，即在其作用域的顶部会先进行变量的声明，通过赋值的匿名函数不会存在函数提升
- 函数提升的优先级高于变量提升

### 五、作用域

作用域是指程序源代码中定义变量的区域，作用域规定了如何查找变量，也就是确定当前执行代码对变量的访问权限，JavaScript采用词法作用域，也就是静态作用域。

静态作用域即，函数的作用域在函数定义的时候就决定了，而动态作用域是在函数调用的时候决定的。

### 六、作用域链

每个作用域都有对其父作用域的引用，当我们访问一个变量的时候，JavaScript引擎会通过变量名在当前位置查找，如果没有找到会一直沿着作用域链向上查找，直到找到全局作用域。

### 七、闭包

闭包是指，在函数A内部有一个函数B，且函数B里引用了函数A中的变量，这时函数B就为一个闭包函数。

若函数B为异步函数（定时器，DOM事件，网络请求等），函数A中的变量在在执行完后不会被销毁，而是等待函数B被执行完后才会被销毁

闭包可以创建私有函数

```
const tasks = []; // 这里存放异步操作的 Promise
const output = (i) => new Promise((resolve) => {
    setTimeout(() => {
        console.log(new Date, i);
        resolve();
    }, 1000 * i);
});

// 生成全部的异步操作
for (var i = 0; i < 5; i++) {
    tasks.push(output(i));
}

// 异步操作完成之后，输出最后的 i
Promise.all(tasks).then(() => {
    setTimeout(() => {
        console.log(new Date, i);
    }, 1000);
});

//async、awiat
const sleep = (timeountMS) => new Promise((resolve) => {
    setTimeout(resolve, timeountMS);
});

(async () => {  // 声明即执行的 async 函数表达式
    for (var i = 0; i < 5; i++) {
        if (i > 0) {
            await sleep(1000);
        }
        console.log(new Date, i);
    }

    await sleep(1000);
    console.log(new Date, i);
})();


```

###  八、闭包的作用

正常情况下函数外部不能访问函数内部的变量，但是通过在闭包可以，在函数里返回闭包函数，通过执行函数即可访问到函数内部的变量。

1. 可以读取函数内部的变量
2. 让这些变量的值始终保持在内存中。
3. 实现封装，属性私有化   ？？？
4. 模块化开发，防止污染全局变量

缺点：

内存泄漏